- include: build.openvpn.rpi.yml
  when: "'development' not in group_names"

- name: Generate OpenVPN config
  docker_container:
    name: generate_openvpn_config
    image: kylemanna/openvpn
    command: "ovpn_genconfig -n {{ pihole.ipv4 }} -u udp://{{ openvpn.dns }}"
    auto_remove: yes
    volumes:
      - "{{ volumes.vpn.config.local_folder }}:{{ volumes.vpn.config.mount }}"

- name: Copy OpenVPN server conf
  template:
    src: openvpn.conf
    dest: "{{ volumes.vpn.config.local_folder }}"
    owner: "{{ user }}"
    group: "{{ user }}"
    mode: 0644
  notify:
    - restart openvpn
  tags: vpn_conf

- name: Generate VPN CA Cert password
  set_fact:
    ca_cert_pw: "{{ lookup('password', 'vpn_ca_cert_password.txt chars=ascii_letters,digits,hexdigits,punctuation length=40') }}"

- name: Generate VPN CA cert
  expect:
    command: "docker run -v {{ volumes.vpn.config.local_folder }}:{{ volumes.vpn.config.mount }} --rm -it kylemanna/openvpn ovpn_initpki"
    responses:
      'Enter New CA Key Passphrase:': "{{ ca_cert_pw }}"
      'Re-Enter New CA Key Passphrase:': "{{ ca_cert_pw }}"
      '\[Easy\-RSA\sCA\]:': "{{ openvpn.dns }}"
      'Enter pass phrase for \/etc\/openvpn\/pki\/private\/ca\.key:': "{{ ca_cert_pw }}"
    timeout: 3600
